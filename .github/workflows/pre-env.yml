name: PR Preview Deployment

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed

env:
  CLUSTER_NAME: "lockthreat-preview-environment"
  RESOURCE_GROUP: "lockthreat-preview-environment"
  ACR_NAME: "lockthreat"
  HELM_RELEASE_NAME: "lockthreat-chart"

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing

      - name: Create Namespace
        run: |
          PR_NAMESPACE="pr-${{ github.event.pull_request.number }}"
          kubectl create namespace $PR_NAMESPACE || echo "Namespace already exists"

      - name: Deploy Application using Helm
        run: |
          PR_NAMESPACE="pr-${{ github.event.pull_request.number }}"
          helm upgrade --install $HELM_RELEASE_NAME-$PR_NAMESPACE ./helm/lockthreat-chart \
            --namespace $PR_NAMESPACE \
            --set ingress.host="pr-${{ github.event.pull_request.number }}.example.com" \
            --set image.repository="$ACR_NAME.azurecr.io/lockthreat-app" \
            --set image.tag="${{ github.sha }}"

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Set up Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing

      - name: Delete Namespace
        run: |
          PR_NAMESPACE="pr-${{ github.event.pull_request.number }}"
          kubectl delete namespace $PR_NAMESPACE --ignore-not-found=true
